---
title: "Nature ç¼–ç¨‹è¯­è¨€é›†æˆ WebView"
date: 2026-01-21
---

ä¸€ä½å¼€å‘è€…å°è¯•åœ¨ nature ç¼–ç¨‹è¯­è¨€ä¸­é›†æˆ WebViewï¼ˆé¡¹ç›®åœ°å€ï¼š[https://github.com/wzzc-dev/nature-webview](https://github.com/wzzc-dev/nature-webview)ï¼‰ï¼Œé‡‡ç”¨ç±»ä¼¼ Rust Tauri çš„é›†æˆæ–¹å¼ï¼Œæœ€ç»ˆæ‰“åŒ…å®Œæˆåå¯ä»¥å¾—åˆ°ä½“ç§¯å°å·§ã€è½»é‡åŒ–çš„å¯æ‰§è¡Œæ¡Œé¢ç¨‹åºã€‚

![](https://raw.githubusercontent.com/weiwenhao/pictures/main/20260122170329099.png)

è¿™ä¸ªç®€å•çš„æ¡Œé¢ç¨‹åºå°±æ˜¯ç”± nature + webview æ‰“åŒ…è€Œæ¥ï¼Œåœ¨ macos arm64 ä¸Šåªæœ‰ 680KB çš„å¤§å°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ›´åŠ ç®€å•çš„ hello world ä»£ç ç¤ºä¾‹

```nature
import webview as w
import webview.{webview_t}
import libc.{cstr, to_cfn}
import co.{sleep}
import co
import runtime

fn interval_callback() {
    co.yield() // Yield coroutine every 10ms to allow GC to run
}

fn other() {
    for true {
        println('other co')
        sleep(1000)
    }
}

fn main() {
    println("Hello, Nature Webview!")

    @async(other(), co.SAME)

    var window = w.create(1, null)
    w.set_title(window, "Hello World".to_cstr())
    w.bind(window, "interval_callback".to_cstr(), to_cfn(interval_callback as anyptr), 0)

    var html = `
      <html>
          <body>
              <script>setInterval(() => {window.interval_callback();}, 10);</script>
              <h1>Hello, Nature!</h1>
          </body>
      </html>`

    w.set_html(window, html.to_cstr())

    w.run(window) // blocking coroutine!
    w.destroy(window)
}

```

nature æ˜¯ä¸€æ¬¾åŸºäºå…¨å±€åç¨‹æ¨¡å‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒä¸ WebView çš„å…¼å®¹æ€§å¹¶ä¸ç†æƒ³ã€‚èµ·åˆè¯¥æ–¹æ¡ˆå®Œå…¨æ— æ³•è¿è¡Œï¼Œnature-webview çš„ä½œè€…ä¸æˆ‘è¿›è¡Œäº†æ²Ÿé€šï¼Œ
æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€é¡¹éå¸¸æœ‰æ„ä¹‰çš„å·¥ä½œï¼Œæ˜¯ nature æ ¸å¿ƒ GUI ç‰¹æ€§çš„é‡è¦ç¯èŠ‚ï¼Œå› æ­¤æˆ‘ç€æ‰‹æ’æŸ¥å¹¶è§£å†³å¯¼è‡´è¿è¡Œå¤±è´¥çš„é—®é¢˜ï¼Œç»è¿‡ä¸€ä¸ªå‘¨æœ«åŠªåŠ›ï¼Œä¸»è¦é—®é¢˜éƒ½è¢«è§£å†³ï¼Œæˆ‘è¿«ä¸åŠå¾…çš„å°†å…¶åˆ†äº«å‡ºæ¥!

## WebView å¿…é¡»è¿è¡Œåœ¨ t0 ç³»ç»Ÿæ ˆ + ç³»ç»Ÿçº¿ç¨‹ä¸­

åœ¨ macOS ç³»ç»Ÿä¸Šï¼Œç¼–è¯‘å®Œæˆåç¨‹åºè™½èƒ½æ­£å¸¸å¯åŠ¨ï¼Œä½†é€šè¿‡ JS å›è°ƒ nature æ—¶å´å‘ç”Ÿäº†å´©æºƒï¼Œä¸”è¿™ä¸ªå´©æºƒçš„è°ƒç”¨æ ˆéå¸¸æ·±ï¼Œéš¾ä»¥è¿½æº¯ã€‚å³ä¾¿é€šè¿‡ Debug æ–¹å¼æ„å»º WebViewï¼Œä¾æ—§æ— æ³•è·å–å®Œæ•´çš„è°ƒç”¨æ ˆã€‚

æœ€ç»ˆå‘ç°è¿™æ˜¯å› ä¸º **WebView åŠ¨æ€ä¾èµ– WebKit åº“ï¼Œè€Œ WebKit åº“æ— æ³•è¿½è¸ªè°ƒç”¨æ ˆ**ã€‚ç»è¿‡å¤šæ¬¡å°è¯•åå¶ç„¶å‘ç°äº† macos çš„å´©æºƒæŠ¥å‘Šï¼Œæˆ‘å‘ç°å…¶ä¸­åŒ…å«äº†å®Œæ•´çš„å †æ ˆè¿½è¸ªæ—¥å¿—ï¼åŸæ¥æˆ‘ä¸€ç›´å¿½ç•¥äº†å¦‚æ­¤é‡è¦çš„ä¿¡æ¯ã€‚ 

> å‘½ä»¤è¡Œæ‰§è¡Œç¨‹åºå´©æºƒæ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ ~/Library/Logs/DiagnosticReports/ ç›´æ¥æŸ¥çœ‹å †æ ˆè¿½è¸ªæ—¥å¿—


```
Crashed Thread:        0  Dispatch queue: com.apple.main-thread
Exception Type:        EXC_BREAKPOINT (SIGTRAP)

Termination Reason:    Namespace SIGNAL, Code 5 Trace/BPT trap: 5
Terminating Process:   exc handler [37708]

Thread 0 Crashed::  Dispatch queue: com.apple.main-thread
0   JavaScriptCore                	    0x7ff828e4b7d1 JSC::LocalAllocator::allocate(JSC::Heap&, JSC::GCDeferralContext*, JSC::AllocationFailureMode)::'lambda'()::operator()() const + 6801
1   JavaScriptCore                	    0x7ff829574b24 JSC::VM::VM(JSC::VM::VMType, JSC::HeapType, WTF::RunLoop*, bool*) + 24452
```

æ ¹æ®æ—¥å¿—å¯ä»¥åˆ¤æ–­è¿™æ˜¯ä¸€ä¸ªé€šè¿‡ç±»ä¼¼ assert æŠ›å‡ºæ¥çš„æ–­ç‚¹ç±»å‹çš„å¼‚å¸¸ï¼Œå¹¶ä¸”å‘ç”Ÿåœ¨å†…å­˜åˆ†é…ä¸­ï¼Œè¯´æ˜è¿™ææœ‰å¯èƒ½å’Œè¿è¡Œç¯å¢ƒç›¸å…³ã€‚

äºæ˜¯æˆ‘å°è¯•ä½¿ç”¨ C + WebView è¿›è¡Œå¯¹æ¯”æµ‹è¯•å¹¶å¤ç°é—®é¢˜ï¼Œnature æ˜¯è¿è¡Œåœ¨åç¨‹å’Œåç¨‹æ ˆä¸­ï¼Œæ‰€ä»¥é€šè¿‡ c åº“çš„ mcontext + mmap stack æ¨¡æ‹Ÿ nature çš„è¿è¡Œæ¨¡å¼ï¼Œæœç„¶é‡ç°äº†é”™è¯¯ã€‚åˆ°è¿™é‡Œå·²ç»å¤§æ¦‚çŒœæµ‹æ˜¯ WebKit ä¼šè¿›è¡Œè¿è¡Œæ—¶æ ˆæ£€æµ‹ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡  pthread_get_stackaddr_np çš„æ–¹å¼ç›´æ¥è¯»å–çº¿ç¨‹é»˜è®¤æ ˆã€‚

è¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼Œå¦‚æœéœ€è¦å…¼å®¹ WebView éœ€è¦å¯¹ nature çš„åŸºç¡€æ¶æ„è¿›è¡Œä¸€å®šæ”¹åŠ¨ã€‚åˆ°ç›®å‰ä¸ºæ­¢éƒ½è¿˜åªæ˜¯çŒœæµ‹ï¼Œä¸ºäº†è¯å®æµ‹æµ‹æˆ‘å»ä¸‹è½½äº†ä¸€ä¸ªå¤š G çš„ WebKit ä»£ç å®šä½å †æ ˆè¿½è¸ªä¸­çš„å‡½æ•°ã€‚æœ€ç»ˆå®šä½åˆ°äº†ä¸‹é¢çš„å…³é”®é€»è¾‘

```c++
ALWAYS_INLINE void* LocalAllocator::allocate(JSC::Heap& heap, size_t cellSize, GCDeferralContext* deferralContext, AllocationFailureMode failureMode)
{
    VM& vm = heap.vm();
    if constexpr (validateDFGDoesGC)
        vm.verifyCanGC();
    return m_freeList.allocateWithCellSize(
        [&]() ALWAYS_INLINE_LAMBDA {
            sanitizeStackForVM(vm);
            return static_cast<HeapCell*>(allocateSlowCase(heap, cellSize, deferralContext, failureMode));
        }, cellSize);
}

```

è¿™ä¸ªå‡½æ•°çš„ç»“æ„å’Œå †æ ˆè¿½è¸ªä¸­æ˜¾ç¤ºçš„ä¸€è‡´ï¼Œè™½ç„¶æœ‰ç‰ˆæœ¬å˜åŠ¨å¸¦æ¥çš„å½±å“ï¼Œä½†æ˜¯å¤§æ¦‚ç‡å°±æ˜¯è¯¥å‡½æ•°å¯¼è‡´äº†å´©æºƒï¼Œè¿›ä¸€æ­¥è¿½è¸ªå‘ç°å…¶ä¸­çš„ sanitizeStackForVM å‡½æ•°æœç„¶ä½¿ç”¨äº† pthread_get_stackaddr_np æ¥è·å–æ ˆä¿¡æ¯å¹¶è¿›è¡Œ assert åˆ¤æ–­ã€‚

é—®é¢˜åˆ°è¿™é‡ŒåŸºæœ¬å·²ç»ç¡®å®šï¼Œå¯ä»¥å°è¯•è§£å†³è¯¥é—®é¢˜ã€‚è¿‡å»æˆ‘çŸ¥é“ UI å¿…é¡»åœ¨ç³»ç»Ÿé»˜è®¤çº¿ç¨‹ä¸Šæ¸²æŸ“ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°æœ‰äº› UI åº“å¯¹æ ˆçš„è¦æ±‚ä¹Ÿå¦‚æ­¤ä¸¥æ ¼ã€‚**ç”±äº nature çš„åç¨‹è¿è¡Œåœ¨å…±äº«æ ˆä¸­ï¼Œæ‰€ä»¥è§£å†³èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ‹¿ç³»ç»Ÿæ ˆä½œä¸ºå…±äº«æ ˆä½¿ç”¨å³å¯ï¼Œä¸è¿‡ç³»ç»Ÿæ ˆè¿˜éœ€è¦é©±åŠ¨ procesor è¿è¡Œï¼Œæ‰€ä»¥æˆ‘æš‚æ—¶æ‹¿å…¶ä¸­ä¸€åŠç³»ç»Ÿæ ˆæ¥ä½œä¸ºåç¨‹çš„å…±äº«æ ˆã€‚**

å½“ç„¶è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼Œåœ¨è¾ƒæ–°çš„ macos 26.2 ç³»ç»Ÿä¸­å¹¶ä¸ä¼šå‘ç”Ÿç±»ä¼¼çš„å´©æºƒï¼Œä»¥åä¹Ÿè®¸å¯ä»¥ç»§ç»­ä½¿ç”¨ mmap è¿›è¡Œæ ˆåˆ†é…ã€‚

## WebView å¿…é¡»ä½¿ç”¨ glibc

ç”±äº macos ç³»ç»Ÿå‘è¡Œç‰ˆæœ¬å•ä¸€ï¼Œå¹¶ä¸”å¼ºåˆ¶è¦æ±‚ä½¿ç”¨åŠ¨æ€åº“é“¾æ¥ï¼Œæ‰€ä»¥ nature åœ¨ macos ä¸Šæ²¡æœ‰é‡åˆ°ç¼–è¯‘é—®é¢˜ï¼Œä½†æ˜¯åœ¨ linux ä¸Šåˆ™å‡ºç°äº†è¯¥é—®é¢˜ã€‚

nature åœ¨ linux ç³»ç»Ÿä¸ŠåŸºäº musl è¿›è¡Œçº¯é™æ€ç¼–è¯‘ï¼Œlibruntime.a + libuv.a + libc.a æ˜¯ nature ä¾èµ–çš„æ ¸å¿ƒï¼Œè¿™ä¸‰ä»¶å¥—éƒ½æ˜¯ musl libc çº¯é™æ€ç¼–è¯‘çš„ï¼Œæ‰€ä»¥è·¨å¹³å°æ€§å¾ˆå¥½ï¼Œä¸€æ¬¡ç¼–è¯‘åˆ°å¤„è¿è¡Œã€‚

ä½† **WebView åœ¨ linux ä¸Šä¾èµ–çš„ webkit å’Œ gtk å¿…é¡»åŸºäº glibc åŠ¨æ€ç¼–è¯‘**ï¼Œè¿™å’Œ nature ç°åœ¨çš„ç¼–è¯‘ç†å¿µäº§ç”Ÿäº†ä¸¥é‡çš„å†²çªã€‚åŠ¨æ€ç¼–è¯‘çš„ webkit å’Œ gtk åœ¨ä¸åŒçš„ linux å‘è¡Œç‰ˆæœ¬ä¸Šä¹Ÿæœ‰ç€å…¼å®¹é—®é¢˜ã€‚éš¾é“è¿™æ— æ³•è§£å†³ä¹ˆï¼Ÿè¿˜çœŸä¸è¡Œï¼ŒRust çš„ tarui åœ¨ linux ç³»ç»Ÿä¸Šä¹ŸåŒæ ·æœ‰ç€è¿™æ ·çš„å…¼å®¹å›°æ‰°ã€‚

æ—¢ç„¶ç°åœ¨ webkit å’Œ gtk ç›´æ¥æ‰“ç ´äº†é™æ€ç¼–è¯‘çš„å¹»æƒ³ï¼Œå¿…é¡»åŠ¨æ€ç¼–è¯‘ï¼Œå¿…é¡»ä¾èµ– glibcï¼Œç‰ºç‰²ä¸€å®šçš„è·¨å¹³å°æ€§ï¼Œé‚£ nature ç´¢æ€§ç›´æ¥æ”¾å¼ƒé™æ€ç¼–è¯‘å’Œäº¤å‰ç¼–è¯‘çš„æ€è·¯ï¼Œç›´æ¥ä½¿ç”¨ glibc è¿›è¡ŒåŠ¨æ€ç¼–è¯‘å¥½äº†ã€‚

ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„é“¾æ¥å™¨ ld å°† nature ä¾èµ–çš„é™æ€åº“ä»£ç å’Œ webkit ç›¸å…³åº“è¿›è¡ŒåŠ¨é™æ€åº“æ··åˆé“¾æ¥åï¼Œç»ˆäºåœ¨ ubuntu 22.04 desktop ä¸Šè¿è¡ŒæˆåŠŸã€‚

>nature æ‰‹å†™çš„é“¾æ¥å™¨åªå®ç°äº†é™æ€ç¼–è¯‘éƒ¨åˆ†ï¼Œæ‰€ä»¥åŠ¨æ€ç¼–è¯‘æ—¶éœ€è¦é€šè¿‡ --ld /usr/local/ld æŒ‡å®šç³»ç»Ÿé“¾æ¥å™¨ã€‚

ä¸ºäº†æ›´å¥½çš„å…¼å®¹æ€§ nature build çš„ --ldflags å‚æ•°è¿˜éœ€è¦è¿›è¡Œè°ƒæ•´ï¼Œåœ¨è¯†åˆ«åˆ°ä¼ é€’ -lc å‚æ•°åï¼Œä¼šè‡ªåŠ¨å»æ‰ libc.a çš„ä¾èµ–ã€‚æœ‰ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„åœ°æ–¹åœ¨äº musl libc å·¥å…·é“¾ç¼–è¯‘çš„ libruntime.a å’Œ libuv.a èƒ½å¤Ÿå’Œ glibc åº“ç›´æ¥æ··åˆé“¾æ¥ä½¿ç”¨ã€‚

æœ€ç»ˆå¾—åˆ°çš„ä»¤äººçœ¼èŠ±ç¼­ä¹±çš„ç¼–è¯‘å‚æ•° ğŸ˜„ï¼Œnature å¹¶ä¸ä¾èµ–äº gcc å·¥å…·é“¾ï¼Œæ‰€ä»¥éœ€è¦åœ¨ ldflags ä¸­å¤„ç† crtendS è¿™æ ·çš„åˆå§‹åŒ–æ–‡ä»¶ã€‚

```
nature build --ld '/usr/bin/ld' --ldflags "/usr/lib/gcc/x86_64-linux-gnu/11/crtbeginS.o /usr/lib/gcc/x86_64-linux-gnu/11/crtendS.o --dynamic-linker=/lib64/ld-linux-x86-64.so.2 -L/usr/lib/x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/11 --whole-archive /usr/local/lib/libwebview.a --no-whole-archive -lwebkit2gtk-4.1 -lgtk-3 -lgdk-3 -lz -lpangocairo-1.0 -lcairo-gobject -lgdk_pixbuf-2.0 -latk-1.0 -lpango-1.0 -lcairo -lharfbuzz -lsoup-3.0 -lgio-2.0 -lgmodule-2.0 -ljavascriptcoregtk-4.1 -lgobject-2.0 -lglib-2.0 -lstdc++ -lgcc_s -lpthread -lc" test.n --verbose
```


## w.run é˜»å¡ runtime

ç°åœ¨è§£å†³æ‰€æœ‰çš„é—®é¢˜äº†ä¹ˆï¼Ÿæ³¨æ„çœ‹è¿™ä¸€è¡Œä»£ç ï¼Œå®ƒç›´æ¥æŒ‡å‘äº†ä¸€ä¸ª c++ å‡½æ•° webview_runï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°æ°¸è¿œä¸ä¼šè¿”å›ã€‚è¿™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```js
w.run(window) // blocking coroutine!
```

ç»è¿‡ä¸Šé¢çš„é€‚é…ï¼Œwebview æˆåŠŸåœ¨åç¨‹ä¸­è¿è¡Œï¼Œå¦‚æœä½ è¶³å¤Ÿäº†è§£åç¨‹çš„è¿è¡ŒåŸç†ï¼Œä½ å°±ä¼šçŸ¥é“è¿™ä¸€è¡Œé˜»å¡æ“ä½œä¼šå ç”¨æ ¸å¿ƒçº¿ç¨‹éƒ½æ§åˆ¶æƒï¼Œè¿™å¯¼è‡´åœ¨è¯¥æ ¸å¿ƒçº¿ç¨‹ä¸Šçš„åç¨‹è°ƒåº¦å™¨å’Œå…¶ä»–åç¨‹æ°¸è¿œéƒ½ä¸ä¼šè¿è¡Œã€‚ä½†è¿™è¿˜ä¸å¤Ÿè‡´å‘½ï¼Œnature å¯ä»¥è½»æ˜“çš„é€šè¿‡åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**çœŸæ­£çš„é—®é¢˜æ˜¯é˜»å¡ç³»ç»Ÿè°ƒç”¨ä¼šå¯¼è‡´è¯¥çº¿ç¨‹æ— æ³•è¿›å…¥ STW çŠ¶æ€ï¼Œä»è€Œé˜»å¡æ•´ä¸ª GCï¼Œè¿™æ‰æ˜¯çœŸæ­£æ— è§£ä¸”è‡´å‘½çš„é—®é¢˜ã€‚**

nature é‡‡ç”¨äº†åä½œå¼çš„è°ƒåº¦æ–¹æ¡ˆï¼Œæ„å‘³ç€æ›´å¤šçš„æ§åˆ¶æƒäº¤åœ¨äº†å¼€å‘è€…æ‰‹ä¸Šï¼Œä¸ºäº†æ›´å‹å¥½çš„ GUI ä½“éªŒï¼Œä¹Ÿè®¸åº”è¯¥å°è¯•ä¸€äº›ä¸åŒçš„æ–¹æ¡ˆã€‚äºæ˜¯æœ€ç»ˆä½¿ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒ hack çš„æ–¹å¼è§£å†³äº†è¯¥é—®é¢˜ã€‚

```nature
w.bind(window, "interval_callback".to_cstr(), to_cfn(co.yield as anyptr), 0)

var html = `
  <html>
	  <body>
		  <script>setInterval(() => {window.interval_callback();}, 10);</script>
		  <h1>Hello, Nature!</h1>
	  </body>
  </html>`
```

**æˆ‘ä»¬åœ¨ js ä»£ç ä¸­åˆ›å»ºäº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯ 10ms è°ƒç”¨ä¸€æ¬¡ nature å‡½æ•°ç»‘å®šï¼Œè¯¥å‡½æ•°ç»‘å®šä¼š yield å½“å‰åç¨‹å°†æ§åˆ¶æƒäº¤è¿˜ç»™åç¨‹è°ƒåº¦å™¨ã€‚** é€šè¿‡è¿™ç§æ–¹å¼ä¸éœ€è¦è°ƒæ•´ä»»ä½•çš„ nature ç¼–è¯‘å™¨è®©æ•´ä¸ªåç¨‹è°ƒåº¦å™¨èƒ½å¤Ÿæ­£å¸¸è¿è½¬ï¼Œä»£ä»·å¤§æ¦‚å°±æ˜¯éœ€è¦ 10ms çš„å»¶è¿Ÿï¼Œè€Œä¸æ˜¯æŒ‰éœ€è°ƒåº¦ç½¢äº†ã€‚ä½†æ˜¯è‡³å°‘ä¸ä¼šäº§ç”Ÿ GC é—®é¢˜ã€‚


## C/C++ å›è°ƒ nature fn

C/C++ æ˜¯ä¸å®‰å…¨éæ‰˜ç®¡çš„å‡½æ•°èƒ½å¤Ÿå›è°ƒ nature å‡½æ•°å—ï¼ŸåŸåˆ™ä¸Šä¸è¡Œï¼Œæ¯”å¦‚ golang ä¸å…è®¸ï¼Œå› ä¸º golang çš„ C ä»£ç å’Œ go ä»£ç è¿è¡Œåœ¨äº†ä¸åŒçš„æ ˆä¸­ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥è°ƒç”¨ã€‚

è€Œ **nature å’Œ C ä»£ç åœ¨åŒä¸€ä¸ªå…±äº«æ ˆä¸­è¿è¡Œ**ï¼Œæ‰€ä»¥å›è°ƒèƒ½å¤Ÿæ­£å¸¸è§¦å‘ã€‚ä½†åœ¨å½“å‰çš„è®¾è®¡ä¸­ï¼Œnature æ²¡æœ‰è€ƒè™‘è¿‡ä½œä¸ºå›è°ƒè¢« C ä»£ç è°ƒç”¨ï¼Œæ‰€ä»¥ GC ä¸èƒ½æ­£ç¡®çš„è¯†åˆ«è¯¥æ··åˆè°ƒç”¨æ¨¡å¼ã€‚ä½†è¿™è¿˜ç®—å¥½è§£å†³ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿½æº¯æ ˆå¸§è·å–æ•´ä¸ªæ ˆä¸Šçš„å‡½æ•°è°ƒç”¨é“¾æ¡å¹¶è¿›è¡Œ GC root mark, C åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åŒæ ·éµå¾ªè¯¥æ ˆå¸§è§„åˆ™ã€‚

å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯é—­åŒ…é—®é¢˜

```go
fn foo() {}

fn main() {
	int a = 1
	fn() f = foo
	f = fn() {
		var b = a // Reference to external var
	}
	
	f()
	foo()

}
```

åœ¨é«˜çº§ç¼–ç¨‹è¯­è¨€ä¸­é€šå¸¸ä¼šåŒºåˆ†é—­åŒ…å’Œå…¨å±€å‡½æ•°ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œé¢å¯¹ä¸€ä¸ª fn ç±»å‹çš„å˜é‡ fï¼Œç¼–è¯‘å™¨æ— æ³•è¿½è¸ªå…¶æ˜¯å…¨å±€å‡½æ•°è¿˜æ˜¯é—­åŒ…ã€‚æ‰€ä»¥é€šå¸¸ä¼šé‡‡å–å¦¥åçš„ç­–ç•¥å°† fn ç±»å‹å˜é‡ç»Ÿä¸€æŒ‰ç…§é—­åŒ…è¿›è¡Œå­˜å‚¨å’Œä½¿ç”¨ã€‚å¦‚å›¾ï¼Œfn å¹¶ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„æŒ‡é’ˆæŒ‡å‘å‡½æ•°çš„åœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ª 16byte çš„ pair ç»“æ„ã€‚


![](https://raw.githubusercontent.com/weiwenhao/pictures/main/20260121020009894.png)
æ‰€ä»¥å¦‚æœç›´æ¥å°† nature ä¸­çš„ global fn é€šè¿‡å‚æ•°è¿›è¡Œä¼ é€’æ—¶ï¼Œè¯¥å‚æ•°æ˜¯ä¸€ä¸ª 16byte çš„å¥‡æ€ªæ•°æ®ï¼ŒC å¹¶ä¸çŸ¥é“ fn çš„åœ°å€æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥è¿˜éœ€è¦ä»é—­åŒ…ä¸­æå– fn åœ°å€ä¼ é€’ç»™ Cã€‚è¿™é‡Œçš„ libc.to_cfn åšäº†ä¸€ä¸ªç®€å•çš„å·¥ä½œï¼Œå°±æ˜¯ç›´æ¥æŠ›å¼ƒ env ptr(å…¨å±€å‡½æ•°çš„ env ptr æ€»æ˜¯ä¸º null)å¹¶ä»ä¸­æå– fn ptr ä¼ é€’ç»™ C å‡½æ•°ã€‚

```nature
w.bind(window, "interval_callback".to_cstr(), libc.to_cfn(interval_callback as anyptr), 0)
```


## æ€»ç»“

åˆ°è¿™é‡Œå·²çŸ¥çš„é—®é¢˜éƒ½å¾—åˆ°äº†è§£å†³ï¼Œè™½ç„¶æ–¹æ¡ˆä¸Šæ¯”è¾ƒå¦¥åï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯è®© nature ç¼–ç¨‹è¯­è¨€æˆåŠŸé›†æˆäº† WebViewï¼Œå¹¶ä¸”èƒ½å¤Ÿè¾¾åˆ°å’Œ C + webview ä¸€æ ·çš„åŸç”Ÿæ€§èƒ½ä½“éªŒï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿäº«å— GC ç¼–ç¨‹è¯­è¨€å¸¦æ¥çš„å®‰å…¨æ€§å’Œåç¨‹çš„ä¾¿åˆ©æ€§ã€‚è€Œ WebView æ˜¯ä¸€ä¸ªå…¸å‹çš„ C/C++ UI åº“çš„ç¤ºä¾‹ï¼Œå¯ä»¥é‡‡ç”¨åŒæ ·çš„æ–¹å¼é›†æˆç±»ä¼¼ sokol/ImGui ç­‰ UI åº“ã€‚

https://nature-lang.cn/news/20260115 å°±å¦‚ä¸Šä¸€ç¯‡æ–‡ç« æœ€åæåˆ°çš„ï¼Œå¯æ§å†…å­˜åˆ†é…å™¨å’Œ unsafe è£¸å‡½æ•°æ”¯æŒæ˜¯åŸæœ¬çš„ GUI æ”¯æŒç­–ç•¥åŸºç¡€ï¼Œä½†æ˜¯æœªæ–™åˆ°å…±äº«æ ˆæ¨¡å¼çš„åç¨‹å’Œ C/C++ çš„å…¼å®¹æ€§å¦‚æ­¤ä¼˜ç§€ï¼Œç›´æ¥å°±å®Œæˆäº†é€‚é…ã€‚ä¸è¿‡è¿™ç§å¦¥åä¸ä¼šæ˜¯æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆï¼Œunsafe è£¸å‡½æ•°å’Œå¯æ§å†…å­˜åˆ†é…æ¨¡å¼çš„å·¥ä½œä¼šç»§ç»­æ¨åŠ¨ã€‚åˆ°æ—¶å€™ nautre çš„ main å‡½æ•°å¯ä»¥é€‰æ‹©ç‹¬ç«‹äºåç¨‹è°ƒåº¦ç³»ç»Ÿé‡‡å–å•ç‹¬çš„çº¿ç¨‹å’Œæ ˆè¿è¡Œï¼Œè®© nature æ›´åŠ é€‚åº”åŸç”Ÿçš„ GUI å¼€å‘ã€‚

å½“ç„¶å›¾å½¢åŒ–æ“ä½œç³»ç»Ÿ windows åŒæ ·æ˜¯ GUI æ”¯æŒé‡è¦ä¸€ä¸ªç¯èŠ‚ï¼Œæˆ‘å°†ä¼šè¿›è¡Œçœ‹è¿›è¡Œæ”¯æŒï¼Œç”±äºè°ƒæ•´äº† nature çš„æºç ï¼Œæ‰€ä»¥éœ€è¦ç­‰åˆ° 0.7.3 ç‰ˆæœ¬å‘å¸ƒæ—¶æ‰èƒ½ä½“éªŒ nature-webviewï¼Œåœ¨è¿™æœŸé—´æˆ‘ä¼šä½¿ç”¨ nature ç»“åˆ webview å¼€å‘ä¸€ä¸ªå°é¡¹ç›®è¿›ä¸€æ­¥æµ‹è¯•å¯ç”¨æ€§ã€‚

å¦‚æœä½ è®¡åˆ’ä½¿ç”¨ nature è¿›è¡Œå¼€æºé¡¹ç›®å¼€å‘æˆ–è€…é›†æˆç°æœ‰çš„ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡ github issue æˆ–è€…å¾®ä¿¡è”ç³»æˆ‘ï¼Œæˆ‘ä¼šä¸ºä½ æä¾›æŠ€æœ¯æŒ‡å¯¼ä»¥åŠå¿«é€Ÿ bug ä¿®å¤ã€‚